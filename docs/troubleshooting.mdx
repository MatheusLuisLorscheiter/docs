---
title: "Troubleshooting"
description: "Resolução de problemas comuns da API Disparador"
---

<Note>
Este guia ajuda a identificar e resolver problemas comuns da API Disparador.
</Note>

## Visão Geral

Este guia aborda os problemas mais comuns e suas soluções para a API Disparador.

<CardGroup cols={3}>
  <Card title="Problemas de Conexão" icon="wifi" color="#dc2626">
    Banco, Redis e Evolution API
  </Card>
  <Card title="Problemas de Performance" icon="cpu" color="#ea580c">
    Memória, CPU e filas
  </Card>
  <Card title="Problemas de Envio" icon="send" color="#2563eb">
    Mensagens e campanhas
  </Card>
</CardGroup>

## Problemas de Conexão

### Banco de Dados PostgreSQL

#### Sintomas
- Erro: `Connection refused`
- Erro: `Authentication failed`
- API não inicia

#### Diagnóstico

<RequestExample>

```bash
# Verificar se PostgreSQL está rodando
sudo systemctl status postgresql

# Testar conexão
psql -h localhost -p 5432 -U disparador -d api-disparador

# Verificar logs do PostgreSQL
sudo tail -f /var/log/postgresql/postgresql-*.log
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="PostgreSQL não inicia" icon="database" color="#dc2626">
    ```bash
    sudo systemctl start postgresql
    sudo systemctl enable postgresql
    ```
  </Card>
  <Card title="Credenciais incorretas" icon="key" color="#2563eb">
    ```bash
    sudo -u postgres psql
    ALTER USER disparador PASSWORD 'nova-senha';
    ```
  </Card>
  <Card title="Banco não existe" icon="database" color="#7c3aed">
    ```bash
    sudo -u postgres createdb api-disparador
    ```
  </Card>
  <Card title="Porta bloqueada" icon="shield" color="#ea580c">
    ```bash
    sudo ufw allow 5432
    ```
  </Card>
</CardGroup>

### Redis

#### Sintomas
- Erro: `Connection timeout`
- Erro: `Redis connection failed`
- Filas não funcionam

#### Diagnóstico

<RequestExample>

```bash
# Verificar se Redis está rodando
sudo systemctl status redis-server

# Testar conexão
redis-cli ping

# Verificar logs do Redis
sudo tail -f /var/log/redis/redis-server.log
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Redis não inicia" icon="server" color="#dc2626">
    ```bash
    sudo systemctl start redis-server
    sudo systemctl enable redis-server
    ```
  </Card>
  <Card title="Porta bloqueada" icon="shield" color="#2563eb">
    ```bash
    sudo ufw allow 6379
    ```
  </Card>
  <Card title="Memória insuficiente" icon="memory" color="#7c3aed">
    ```bash
    # Aumentar memória no redis.conf
    maxmemory 512mb
    ```
  </Card>
  <Card title="Senha incorreta" icon="key" color="#ea580c">
    ```bash
    # Configurar senha no redis.conf
    requirepass sua-senha
    ```
  </Card>
</CardGroup>

### Evolution API

#### Sintomas
- Erro: `Evolution API connection failed`
- Mensagens não são enviadas
- Erro: `Instance not found`

#### Diagnóstico

<RequestExample>

```bash
# Testar conectividade
curl -X GET https://sua-evolution-api.com/instance/connectionState/minha-instancia

# Verificar se a instância está conectada
curl -X GET https://sua-evolution-api.com/instance/fetchInstances
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="URL incorreta" icon="link" color="#dc2626">
    Verificar se a URL está correta e acessível
  </Card>
  <Card title="API Key inválida" icon="key" color="#2563eb">
    Gerar nova API key na Evolution API
  </Card>
  <Card title="Instância não conectada" icon="wifi" color="#7c3aed">
    Reconectar a instância no WhatsApp
  </Card>
  <Card title="Rate limit" icon="clock" color="#ea580c">
    Aguardar e reduzir frequência de envio
  </Card>
</CardGroup>

## Problemas de Performance

### Alto Uso de CPU

#### Sintomas
- CPU acima de 80%
- Aplicação lenta
- Timeout de requisições

#### Diagnóstico

<RequestExample>

```bash
# Verificar uso de CPU
top -p $(pgrep -f api-disparador)

# Verificar threads
jstack $(pgrep -f api-disparador) > thread-dump.txt

# Verificar métricas
curl http://localhost:8080/api/actuator/metrics/process.cpu.usage
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Muitas campanhas" icon="play" color="#dc2626">
    Reduzir número de campanhas simultâneas
  </Card>
  <Card title="Intervalo muito baixo" icon="clock" color="#2563eb">
    Aumentar `CAMPAIGN_INTERVAL_MIN`
  </Card>
  <Card title="Pool pequeno" icon="settings" color="#7c3aed">
    Aumentar `DB_POOL_SIZE` e `SERVER_MAX_THREADS`
  </Card>
  <Card title="Logs excessivos" icon="file-text" color="#ea580c">
    Reduzir `LOGGING_LEVEL_COM_DISPARADOR`
  </Card>
</CardGroup>

### Alto Uso de Memória

#### Sintomas
- `OutOfMemoryError`
- Aplicação trava
- Garbage collection frequente

#### Diagnóstico

<RequestExample>

```bash
# Verificar uso de memória
jstat -gc $(pgrep -f api-disparador)

# Verificar heap
curl http://localhost:8080/api/actuator/metrics/jvm.memory.used

# Verificar logs de GC
tail -f /var/log/api-disparador/application.log | grep GC
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Heap insuficiente" icon="memory" color="#dc2626">
    ```bash
    java -Xmx2g -Xms1g -jar api-disparador.jar
    ```
  </Card>
  <Card title="Memory leak" icon="leak" color="#2563eb">
    Verificar se campanhas antigas são limpas
  </Card>
  <Card title="Cache grande" icon="database" color="#7c3aed">
    Reduzir pool de conexões
  </Card>
  <Card title="Logs em memória" icon="file-text" color="#ea580c">
    Configurar rotação de logs
  </Card>
</CardGroup>

## Problemas de Envio

### Mensagens Não Enviadas

#### Sintomas
- Campanha criada mas mensagens não saem
- Status da campanha não muda
- Logs mostram erros de envio

#### Diagnóstico

<RequestExample>

```bash
# Verificar status da campanha
curl -H "X-Access-Token: {token}" \
  http://localhost:8080/api/campaigns/{campaign_id}

# Verificar logs de envio
tail -f /var/log/api-disparador/application.log | grep "Mensagem enviada"

# Verificar filas
redis-cli llen message_queue
redis-cli llen scheduled_queue
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Worker parado" icon="cpu" color="#dc2626">
    ```bash
    # Verificar se worker está rodando
    ps aux | grep MessageQueueWorker
    ```
  </Card>
  <Card title="Fila cheia" icon="list" color="#2563eb">
    ```bash
    # Limpar filas se necessário
    redis-cli del message_queue
    ```
  </Card>
  <Card title="Evolution API down" icon="server" color="#7c3aed">
    Verificar conectividade com Evolution API
  </Card>
  <Card title="Rate limit" icon="clock" color="#ea580c">
    Aguardar e reduzir frequência
  </Card>
</CardGroup>

### Campanhas Pausadas

#### Sintomas
- Campanha não retoma após pausa
- Erro: `Campanha não pode ser retomada`
- Status permanece PAUSED

#### Diagnóstico

<RequestExample>

```bash
# Verificar quando foi pausada
curl -H "X-Access-Token: {token}" \
  http://localhost:8080/api/campaigns/{campaign_id}

# Verificar logs de pausa
tail -f /var/log/api-disparador/application.log | grep "pausada"
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Tempo expirado" icon="clock" color="#dc2626">
    Campanhas só podem ser retomadas em 1 dia
  </Card>
  <Card title="Campanha cancelada" icon="x-circle" color="#2563eb">
    Campanhas canceladas não podem ser retomadas
  </Card>
  <Card title="Worker parado" icon="cpu" color="#7c3aed">
    Reiniciar worker para processar retomada
  </Card>
  <Card title="Banco inconsistente" icon="database" color="#ea580c">
    Verificar integridade dos dados
  </Card>
</CardGroup>

## Problemas de Autenticação

### Token Inválido

#### Sintomas
- Erro 401 Unauthorized
- `Access token inválido`
- Não consegue acessar endpoints

#### Diagnóstico

<RequestExample>

```bash
# Verificar se token está sendo enviado
curl -v -H "X-Access-Token: {token}" \
  http://localhost:8080/api/campaigns

# Verificar se token é válido
# (implementar validação no código)
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Token inválido" icon="key" color="#dc2626">
    Gerar novo token via registro
  </Card>
  <Card title="Token malformado" icon="key" color="#2563eb">
    Verificar formato do token
  </Card>
  <Card title="Header incorreto" icon="settings" color="#7c3aed">
    Usar header `X-Access-Token`
  </Card>
  <Card title="Token inválido" icon="key" color="#ea580c">
    Verificar se o token está correto
  </Card>
</CardGroup>

## Problemas de Configuração

### Variáveis de Ambiente

#### Sintomas
- Aplicação não inicia
- Configurações não aplicadas
- Valores padrão sendo usados

#### Diagnóstico

<RequestExample>

```bash
# Verificar variáveis de ambiente
env | grep -E "(DB_|REDIS_|CAMPAIGN_)"

# Verificar arquivo .env
cat .env

# Verificar logs de inicialização
tail -f /var/log/api-disparador/application.log | grep "Configuration"
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Arquivo .env não carregado" icon="file" color="#dc2626">
    ```bash
    # Carregar variáveis
    source .env
    ```
  </Card>
  <Card title="Variável não definida" icon="settings" color="#2563eb">
    Verificar se todas as variáveis obrigatórias estão definidas
  </Card>
  <Card title="Formato incorreto" icon="code" color="#7c3aed">
    Verificar sintaxe das variáveis
  </Card>
  <Card title="Permissões" icon="shield" color="#ea580c">
    Verificar permissões do arquivo .env
  </Card>
</CardGroup>

## Problemas de Logs

### Logs Não Aparecem

#### Sintomas
- Nenhum log sendo gerado
- Logs não no local esperado
- Logs com formato incorreto

#### Diagnóstico

<RequestExample>

```bash
# Verificar se diretório existe
ls -la /var/log/api-disparador/

# Verificar permissões
ls -la /var/log/api-disparador/application.log

# Verificar configuração de logs
curl http://localhost:8080/api/actuator/env | grep LOGGING
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Diretório não existe" icon="folder" color="#dc2626">
    ```bash
    sudo mkdir -p /var/log/api-disparador
    sudo chown $USER:$USER /var/log/api-disparador
    ```
  </Card>
  <Card title="Permissões incorretas" icon="shield" color="#2563eb">
    ```bash
    sudo chmod 755 /var/log/api-disparador
    sudo chmod 644 /var/log/api-disparador/application.log
    ```
  </Card>
  <Card title="Nível de log muito alto" icon="settings" color="#7c3aed">
    Reduzir `LOGGING_LEVEL_COM_DISPARADOR`
  </Card>
  <Card title="Logs em console" icon="terminal" color="#ea580c">
    Verificar se `LOG_FILE` está configurado
  </Card>
</CardGroup>

## Problemas de Rede

### Porta Bloqueada

#### Sintomas
- `Connection refused`
- Não consegue acessar API
- Timeout de conexão

#### Diagnóstico

<RequestExample>

```bash
# Verificar se porta está em uso
netstat -tulpn | grep :8080

# Verificar firewall
sudo ufw status

# Testar conectividade
telnet localhost 8080
```

</RequestExample>

#### Soluções

<CardGroup cols={2}>
  <Card title="Porta em uso" icon="hash" color="#dc2626">
    ```bash
    # Encontrar processo
    lsof -i :8080
    # Matar processo
    kill -9 <PID>
    ```
  </Card>
  <Card title="Firewall bloqueando" icon="shield" color="#2563eb">
    ```bash
    sudo ufw allow 8080
    ```
  </Card>
  <Card title="Aplicação não iniciou" icon="server" color="#7c3aed">
    Verificar logs de inicialização
  </Card>
  <Card title="Proxy/load balancer" icon="network" color="#ea580c">
    Verificar configuração de proxy
  </Card>
</CardGroup>

## Scripts de Diagnóstico

### Script Completo de Diagnóstico

<RequestExample>

```bash
#!/bin/bash

echo "=== DIAGNÓSTICO API DISPARADOR ==="
echo

# Verificar se aplicação está rodando
echo "1. Verificando se aplicação está rodando..."
if pgrep -f api-disparador > /dev/null; then
    echo "✅ Aplicação está rodando"
else
    echo "❌ Aplicação não está rodando"
fi

# Verificar PostgreSQL
echo
echo "2. Verificando PostgreSQL..."
if pg_isready -h localhost -p 5432; then
    echo "✅ PostgreSQL está conectado"
else
    echo "❌ PostgreSQL não está conectado"
fi

# Verificar Redis
echo
echo "3. Verificando Redis..."
if redis-cli ping > /dev/null 2>&1; then
    echo "✅ Redis está conectado"
else
    echo "❌ Redis não está conectado"
fi

# Verificar health check
echo
echo "4. Verificando health check..."
if curl -s http://localhost:8080/api/actuator/health > /dev/null; then
    echo "✅ Health check OK"
else
    echo "❌ Health check falhou"
fi

# Verificar uso de recursos
echo
echo "5. Verificando uso de recursos..."
CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
MEM=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
echo "CPU: ${CPU}%"
echo "Memória: ${MEM}%"

# Verificar logs recentes
echo
echo "6. Últimos logs de erro..."
tail -n 5 /var/log/api-disparador/application.log | grep ERROR || echo "Nenhum erro recente"

echo
echo "=== DIAGNÓSTICO CONCLUÍDO ==="
```

</RequestExample>

### Script de Limpeza

<RequestExample>

```bash
#!/bin/bash

echo "=== LIMPEZA API DISPARADOR ==="
echo

# Parar aplicação
echo "1. Parando aplicação..."
pkill -f api-disparador

# Limpar filas Redis
echo "2. Limpando filas Redis..."
redis-cli del message_queue
redis-cli del scheduled_queue
redis-cli del retry_queue

# Limpar logs antigos
echo "3. Limpando logs antigos..."
find /var/log/api-disparador -name "*.log.*" -mtime +7 -delete

# Reiniciar serviços
echo "4. Reiniciando serviços..."
sudo systemctl restart postgresql
sudo systemctl restart redis-server

# Iniciar aplicação
echo "5. Iniciando aplicação..."
nohup java -jar api-disparador.jar > /dev/null 2>&1 &

echo "✅ Limpeza concluída"
```

</RequestExample>

## Próximos Passos

<CardGroup cols={3}>
  <Card title="Configuração" icon="settings" href="/configuration">
    Configure corretamente
  </Card>
  <Card title="Monitoramento" icon="activity" href="/monitoring">
    Configure monitoramento
  </Card>
  <Card title="Suporte" icon="help-circle" href="mailto:suporte@disparador.com">
    Entre em contato
  </Card>
</CardGroup> 