---
title: "Health Check Detalhado"
api: "GET /api/metrics/health"
description: "Health check customizado com informações detalhadas de filas e processamento"
---

<Tip>
Este é um endpoint customizado que fornece informações mais detalhadas sobre filas e processamento, complementando o health check padrão do Actuator.
</Tip>

## Visão Geral

Endpoint especializado que monitora:
- Status das filas de mensagens
- Conexão com Evolution API
- Status do banco de dados
- Estatísticas de processamento

## Headers

<ParamField header="X-Access-Token" type="string" required>
  Token de acesso da empresa
</ParamField>

<RequestExample>

```bash cURL
curl -X GET https://api.disparador.com/api/metrics/health \
  -H "X-Access-Token: seu-access-token"
```

```javascript JavaScript
const response = await fetch('https://api.disparador.com/api/metrics/health', {
  headers: {
    'X-Access-Token': 'seu-access-token'
  }
});

const health = await response.json();

// Verificar status das filas
if (health.queues?.status === 'UP') {
  console.log('✅ Filas funcionando');
  console.log(`  Mensagens na fila: ${health.queues.details.messageQueue}`);
  console.log(`  Agendadas: ${health.queues.details.scheduledQueue}`);
} else {
  console.error('❌ Problema nas filas');
}
```

```python Python
import requests

headers = {'X-Access-Token': 'seu-access-token'}
response = requests.get('https://api.disparador.com/api/metrics/health', headers=headers)
health = response.json()

# Analisar cada componente
for component, data in health.items():
    status = data.get('status', 'UNKNOWN')
    print(f"{component}: {status}")
    
    if 'details' in data:
        for key, value in data['details'].items():
            print(f"  - {key}: {value}")
```

</RequestExample>

## Response

<ResponseField name="queues" type="object">
  Status das filas de processamento
  
  <Expandable title="Detalhes das filas">
    - `messageQueue` - Mensagens aguardando envio
    - `scheduledQueue` - Mensagens agendadas
    - `retryQueue` - Mensagens para retry
    - `activeWorkers` - Workers ativos
  </Expandable>
</ResponseField>

<ResponseField name="evolution" type="object">
  Status da conexão com Evolution API
</ResponseField>

<ResponseField name="database" type="object">
  Status do banco de dados
</ResponseField>

<ResponseField name="overallStatus" type="string">
  Status geral do sistema (UP/DOWN/DEGRADED)
</ResponseField>

<ResponseExample>

```json 200 - Sistema Saudável
{
  "queues": {
    "status": "UP",
    "details": {
      "messageQueue": 15,
      "scheduledQueue": 42,
      "retryQueue": 0,
      "activeWorkers": 3
    }
  },
  "evolution": {
    "status": "UP",
    "details": {
      "activeConfigs": 2,
      "connected": true
    }
  },
  "database": {
    "status": "UP",
    "details": {
      "type": "PostgreSQL",
      "activeConnections": 5
    }
  },
  "overallStatus": "UP"
}
```

```json 503 - Sistema Degradado
{
  "queues": {
    "status": "UP",
    "details": {
      "messageQueue": 1250,
      "scheduledQueue": 89,
      "retryQueue": 45,
      "activeWorkers": 3
    }
  },
  "evolution": {
    "status": "DOWN",
    "details": {
      "error": "Connection timeout"
    }
  },
  "database": {
    "status": "UP",
    "details": {
      "type": "PostgreSQL",
      "activeConnections": 12
    }
  },
  "overallStatus": "DEGRADED"
}
```

</ResponseExample>

## Interpretação dos Status

### Filas (queues)
- **UP**: Filas funcionando normalmente
- **DOWN**: Erro ao conectar com Redis
- **DEGRADED**: Fila muito cheia (>1000 mensagens)

### Evolution API
- **UP**: Pelo menos uma configuração conectada
- **DOWN**: Nenhuma configuração disponível ou todas offline

### Database
- **UP**: Conexão normal
- **DOWN**: Sem conexão com banco

### Overall Status
- **UP**: Todos os componentes funcionando
- **DEGRADED**: Sistema funcional mas com problemas
- **DOWN**: Sistema inoperante

## Monitoramento de Filas

```javascript
// Monitorar tamanho das filas
async function monitorQueues(accessToken) {
  const response = await fetch('https://api.disparador.com/api/metrics/health', {
    headers: { 'X-Access-Token': accessToken }
  });
  
  const health = await response.json();
  const queues = health.queues?.details;
  
  if (!queues) return;
  
  // Alertar se fila muito grande
  if (queues.messageQueue > 1000) {
    console.warn(`⚠️ Fila de mensagens muito grande: ${queues.messageQueue}`);
  }
  
  // Alertar se muitos retries
  if (queues.retryQueue > 100) {
    console.error(`❌ Muitas mensagens falhando: ${queues.retryQueue} em retry`);
  }
  
  // Verificar workers
  if (queues.activeWorkers === 0) {
    console.error('❌ Nenhum worker ativo!');
  }
}
```

## Diferença do Health Padrão

| Característica | /actuator/health | /api/metrics/health |
|----------------|------------------|---------------------|
| Autenticação | Não requer | Requer token |
| Detalhes | Genérico | Específico do negócio |
| Filas | Não inclui | Informações detalhadas |
| Workers | Não inclui | Status dos workers |

## Alertas Recomendados

<Warning>
Configure alertas para:
- `messageQueue > 1000` - Fila congestionada
- `retryQueue > 100` - Muitas falhas
- `activeWorkers = 0` - Processamento parado
- `overallStatus != UP` - Sistema com problemas
</Warning>

## Uso em Dashboards

```javascript
// Criar dashboard de monitoramento
async function updateDashboard(accessToken) {
  const response = await fetch('https://api.disparador.com/api/metrics/health', {
    headers: { 'X-Access-Token': accessToken }
  });
  
  const health = await response.json();
  
  // Atualizar elementos do dashboard
  document.getElementById('queue-size').textContent = 
    health.queues?.details?.messageQueue || 0;
  
  document.getElementById('retry-count').textContent = 
    health.queues?.details?.retryQueue || 0;
  
  document.getElementById('workers').textContent = 
    health.queues?.details?.activeWorkers || 0;
  
  // Atualizar status visual
  const statusElement = document.getElementById('system-status');
  statusElement.className = `status-${health.overallStatus?.toLowerCase()}`;
  statusElement.textContent = health.overallStatus;
}

// Atualizar a cada 30 segundos
setInterval(() => updateDashboard('seu-token'), 30000);
```