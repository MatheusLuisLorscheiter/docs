---
title: "Monitoramento"
description: "Como monitorar a API Disparador"
---

<Note>
  Este guia mostra como configurar monitoramento completo para a API Disparador, incluindo métricas, logs e alertas.
</Note>

## Visão Geral

O monitoramento é essencial para garantir a saúde e performance da API Disparador em produção.

<CardGroup cols={3}>
  <Card title="Métricas" icon="chart-bar" color="#16a34a">
    Performance e uso de recursos
  </Card>
  <Card title="Logs" icon="file-text" color="#2563eb">
    Rastreamento de eventos
  </Card>
  <Card title="Alertas" icon="bell" color="#dc2626">
    Notificações de problemas
  </Card>
</CardGroup>

## Métricas Disponíveis

### Métricas da Aplicação

<CardGroup cols={2}>
  <Card title="Campanhas Ativas" icon="play" color="#16a34a">
    `disparador.campaigns.active`
  </Card>
  <Card title="Mensagens Enviadas" icon="send" color="#2563eb">
    `disparador.messages.sent`
  </Card>
  <Card title="Mensagens Falhadas" icon="x-circle" color="#dc2626">
    `disparador.messages.failed`
  </Card>
  <Card title="Taxa de Sucesso" icon="percent" color="#7c3aed">
    Calculada: sent/(sent\+failed)
  </Card>
</CardGroup>

### Métricas do Sistema

<CardGroup cols={2}>
  <Card title="Uso de CPU" icon="cpu" color="#16a34a">
    `process.cpu.usage`
  </Card>
  <Card title="Uso de Memória" icon="memory" color="#2563eb">
    `jvm.memory.used`
  </Card>
  <Card title="Threads Ativas" icon="activity" color="#7c3aed">
    `jvm.threads.live`
  </Card>
  <Card title="Requisições HTTP" icon="server" color="#ea580c">
    `http.server.requests`
  </Card>
</CardGroup>

## Endpoints de Métricas

### Listar Métricas Disponíveis

<RequestExample>

```bash cURL
curl -X GET https://{url-key}/api/actuator/metrics
```

</RequestExample>

<ResponseExample>

```json Métricas Disponíveis
{
  "names": [
    "jvm.memory.used",
    "jvm.memory.max",
    "jvm.threads.live",
    "jvm.threads.peak",
    "process.cpu.usage",
    "process.uptime",
    "http.server.requests",
    "disparador.campaigns.active",
    "disparador.messages.sent",
    "disparador.messages.failed"
  ]
}
```

</ResponseExample>

### Obter Métrica Específica

<RequestExample>

```bash cURL
curl -X GET https://{url-key}/api/actuator/metrics/disparador.campaigns.active
```

</RequestExample>

<ResponseExample>

```json Métrica de Campanhas Ativas
{
  "name": "disparador.campaigns.active",
  "description": "Número de campanhas ativas",
  "baseUnit": null,
  "measurements": [
    {
      "statistic": "VALUE",
      "value": 5.0
    }
  ],
  "availableTags": []
}
```

</ResponseExample>

## Prometheus

### Configuração do Prometheus

<RequestExample>

```yaml
# prometheus.yml
global:
  scrape_interval: 30s
  evaluation_interval: 30s

scrape_configs:
  - job_name: 'api-disparador'
    static_configs:
      - targets: ['localhost:80']
    metrics_path: '/api/actuator/prometheus'
    scrape_interval: 30s
    scrape_timeout: 10s
```

</RequestExample>

### Métricas Prometheus

<RequestExample>

```bash cURL
curl -X GET https://{url-key}/api/actuator/prometheus
```

</RequestExample>

<ResponseExample>

```prometheus
# HELP jvm_memory_used_bytes The amount of used memory
# TYPE jvm_memory_used_bytes gauge
jvm_memory_used_bytes{area="heap",id="PS Eden Space"} 2.097152E7

# HELP disparador_campaigns_active Number of active campaigns
# TYPE disparador_campaigns_active gauge
disparador_campaigns_active 5.0

# HELP disparador_messages_sent_total Total number of sent messages
# TYPE disparador_messages_sent_total counter
disparador_messages_sent_total 1250.0

# HELP disparador_messages_failed_total Total number of failed messages
# TYPE disparador_messages_failed_total counter
disparador_messages_failed_total 25.0
```

</ResponseExample>

## Grafana Dashboards

### Dashboard Principal

<RequestExample>

```json
{
  "dashboard": {
    "title": "API Disparador - Dashboard Principal",
    "panels": [
      {
        "title": "Campanhas Ativas",
        "type": "stat",
        "targets": [
          {
            "expr": "disparador_campaigns_active",
            "legendFormat": "Campanhas"
          }
        ]
      },
      {
        "title": "Mensagens por Minuto",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(disparador_messages_sent_total[1m])",
            "legendFormat": "Enviadas"
          },
          {
            "expr": "rate(disparador_messages_failed_total[1m])",
            "legendFormat": "Falhadas"
          }
        ]
      },
      {
        "title": "Taxa de Sucesso",
        "type": "gauge",
        "targets": [
          {
            "expr": "(disparador_messages_sent_total / (disparador_messages_sent_total + disparador_messages_failed_total)) * 100",
            "legendFormat": "Sucesso %"
          }
        ]
      }
    ]
  }
}
```

</RequestExample>

### Alertas Recomendados

<CardGroup cols={2}>
  <Card title="API Down" icon="alert-triangle" color="#dc2626">
    `up == 0` - API não responde
  </Card>
  <Card title="Alta Taxa de Falha" icon="x-circle" color="#dc2626">
    `rate(disparador_messages_failed_total[5m]) > 0.1`
  </Card>
  <Card title="Muitas Campanhas" icon="play" color="#ea580c">
    `disparador_campaigns_active > 50`
  </Card>
  <Card title="Alto Uso de CPU" icon="cpu" color="#ea580c">
    `process_cpu_usage > 0.8`
  </Card>
</CardGroup>

## Logs

### Configuração de Logs

<RequestExample>

```bash
# Configurar logs estruturados
export LOGGING_LEVEL_COM_DISPARADOR=INFO
export LOG_FILE=/var/log/api-disparador/application.log
export LOG_MAX_SIZE=100MB
export LOG_MAX_HISTORY=30
```

</RequestExample>

### Padrão de Logs

<RequestExample>

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "INFO",
  "logger": "com.disparador.services.CampaignService",
  "message": "Campanha criada com sucesso",
  "campaignId": 123,
  "campaignName": "Campanha de Teste",
  "totalContacts": 100,
  "companyId": 1
}
```

</RequestExample>

### Logs Importantes

<CardGroup cols={2}>
  <Card title="Criação de Campanha" icon="plus" color="#16a34a">
    `Campanha criada com sucesso`
  </Card>
  <Card title="Envio de Mensagem" icon="send" color="#2563eb">
    `Mensagem enviada com sucesso`
  </Card>
  <Card title="Falha de Envio" icon="x-circle" color="#dc2626">
    `Erro ao enviar mensagem`
  </Card>
  <Card title="Campanha Concluída" icon="check-circle" color="#059669">
    `Campanha concluída`
  </Card>
</CardGroup>

## ELK Stack

### Configuração do Logstash

<RequestExample>

```ruby
# logstash.conf
input {
  file {
    path => "/var/log/api-disparador/application.log"
    type => "api-disparador"
    codec => json
  }
}

filter {
  if [type] == "api-disparador" {
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "api-disparador-%{+YYYY.MM.dd}"
  }
}
```

</RequestExample>

### Queries Úteis do Elasticsearch

<RequestExample>

```json
// Campanhas criadas hoje
{
  "query": {
    "bool": {
      "must": [
        {"match": {"message": "Campanha criada com sucesso"}},
        {"range": {"@timestamp": {"gte": "now-1d"}}}
      ]
    }
  }
}

// Erros de envio
{
  "query": {
    "bool": {
      "must": [
        {"match": {"message": "Erro ao enviar mensagem"}},
        {"range": {"@timestamp": {"gte": "now-1h"}}}
      ]
    }
  }
}
```

</RequestExample>

## Alertas

### Configuração de Alertas

<RequestExample>

```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@disparador.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'team-disparador'

receivers:
  - name: 'team-disparador'
    email_configs:
      - to: 'suporte@disparador.com'
    webhook_configs:
      - url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
```

</RequestExample>

### Regras de Alerta

<RequestExample>

```yaml
# disparador-alerts.yml
groups:
  - name: api-disparador
    rules:
      - alert: APIDisparadorDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API Disparador está down"
          description: "A API não está respondendo há mais de 1 minuto"

      - alert: HighFailureRate
        expr: rate(disparador_messages_failed_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Alta taxa de falha de mensagens"
          description: "Taxa de falha está acima de 10%"

      - alert: TooManyActiveCampaigns
        expr: disparador_campaigns_active > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Muitas campanhas ativas"
          description: "Mais de 50 campanhas ativas simultaneamente"

      - alert: HighCPUUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto uso de CPU"
          description: "CPU está acima de 80%"
```

</RequestExample>

## Monitoramento de Infraestrutura

### Docker

<RequestExample>

```bash
# Verificar containers
docker ps | grep api-disparador

# Ver logs do container
docker logs -f api-disparador

# Ver uso de recursos
docker stats api-disparador
```

</RequestExample>

### Sistema

<RequestExample>

```bash
# Verificar uso de CPU e memória
top -p $(pgrep -f api-disparador)

# Verificar uso de disco
df -h /var/log/api-disparador

# Verificar conectividade
netstat -tulpn | grep :80
```

</RequestExample>

## Dashboards Recomendados

### Dashboard de Operações

<CardGroup cols={3}>
  <Card title="Visão Geral" icon="eye" color="#16a34a">
    Status geral da API
  </Card>
  <Card title="Performance" icon="trending-up" color="#2563eb">
    Métricas de performance
  </Card>
  <Card title="Campanhas" icon="play" color="#7c3aed">
    Status das campanhas
  </Card>
  <Card title="Mensagens" icon="send" color="#ea580c">
    Taxa de envio e falhas
  </Card>
  <Card title="Sistema" icon="server" color="#059669">
    Recursos do sistema
  </Card>
  <Card title="Logs" icon="file-text" color="#dc2626">
    Logs em tempo real
  </Card>
</CardGroup>

## Integração com Ferramentas

### Slack

<RequestExample>

```yaml
# Configuração do webhook do Slack
webhook_configs:
  - url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    channel: '#api-disparador'
    username: 'API Disparador Bot'
    icon_emoji: ':warning:'
```

</RequestExample>

### Email

<RequestExample>

```yaml
# Configuração de email
email_configs:
  - to: 'suporte@disparador.com'
    send_resolved: true
    headers:
      subject: 'Alerta API Disparador'
```

</RequestExample>

### PagerDuty

<RequestExample>

```yaml
# Configuração do PagerDuty
pagerduty_configs:
  - routing_key: 'your-pagerduty-key'
    description: 'API Disparador Alert'
    severity: '{{ if eq .GroupLabels.severity "critical" }}critical{{ else }}warning{{ end }}'
```

</RequestExample>

## Próximos Passos

<CardGroup cols={3}>
  <Card title="Configuração" icon="settings" href="/configuration">
    Configure variáveis de ambiente
  </Card>
  <Card title="Deployment" icon="rocket" href="/deployment">
    Faça o deploy da aplicação
  </Card>
  <Card title="Troubleshooting" icon="wrench" href="/troubleshooting">
    Resolva problemas
  </Card>
</CardGroup>